apiVersion: camel.apache.org/v1
kind: Integration
metadata:
  name: mastodon-stream.yaml
spec:
  flows:
    - route:
        from:
          uri: vertx:public.source
          steps:
            - to:
                uri: stream:out
    - route:
        from:
          uri: stream:http?httpUrl=https://foojay.social/api/v1/streaming/public
          steps:
            # Split SEE stream on newline characters
            - split:
                expression:
                  tokenize:
                    token: '"\n"'
            # Filter out lines which do not start with JSON Data
            - filter:
                expression:
                  simple:
                    expression: '${body} startsWith "data: {"'
            # Strip the leading "data: " from the SSE event
            - transform:
                expression:
                  simple:
                    expression: '${body.replaceAll("^data: *", "")}'
                    resultType: java.lang.String
            # Extract the fields we care about into headers using JSONPath
            - setHeader:
                name: content
                expression:
                  jsonpath:
                    expression: $.content
            - setHeader:
                name: created
                expression:
                  jsonpath:
                    expression: $.created_at
            - setHeader:
                name: account
                expression:
                  jsonpath:
                    expression: $.account.acct
            # Create a JSON document from the extracted fields
            - setBody:
                expression:
                  simple:
                    expression: |-
                      {
                          "account": "${header.account}",
                          "content": "${header.content}",
                          "created": "${header.created}"
                      }
            # Send the JSON Body via the Vert.x event bus
            - to:
                uri: vertx:public.source
