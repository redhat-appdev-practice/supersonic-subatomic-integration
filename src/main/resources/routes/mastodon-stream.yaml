apiVersion: camel.apache.org/v1
kind: Integration
metadata:
  name: mastodon-stream.yaml
spec:
  flows:
    - route:
        from:
          uri: vertx:public.source
          steps:
            - to:
                uri: stream:out
                description: Send JSON body to stdout
          description: Consume JSON data from the Vert.x event bus
    - route:
        from:
          uri: stream:http?httpUrl=https://foojay.social/api/v1/streaming/public
          steps:
            - split:
                expression:
                  tokenize:
                    token: '"\n"'
                description: Split SSE data by newlines
            - filter:
                expression:
                  simple:
                    expression: '${body} startsWith "data: {"'
                description: Filter for data elements
            - transform:
                expression:
                  simple:
                    expression: '${body.replaceAll("^data: *", "")}'
                    resultType: java.lang.String
                description: Extract JSON data
            - filter:
                expression:
                  jsonpath:
                    expression: $.language == "en"
                description: Filter for only English posts
            - unmarshal:
                json:
                  library: gson
                  unmarshalType: java.util.Map
                description: Deserialize the JSON data into a Java Map
            - setBody:
                expression:
                  simple:
                    expression: |-
                      {
                          "account": "${in.body.get("account").get("acct")}",
                          "content": "${in.body.get("content")}",
                          "created": "${in.body.get("created_at")}"
                      }
                description: >-
                  Using the extracted data, create a JSON body with the desired
                  fields
            - to:
                uri: vertx:public.source
                description: Send the JSON body via Vert.x event bus
          description: Get Mastodon events via SSE
